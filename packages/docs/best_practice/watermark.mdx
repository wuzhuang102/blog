import ImgZoom from '../.././../src/components/common/ImgZoom';

# 水印

1. 使用 canvas/svg/node 绘制水印内容并转成 base64 图片
2. 将对应 base64 设置成 div 背景，并禁用鼠标事件：`pointer-events:none`
3. 使用`MutationObserver` 监听对应 div，用户修改样式时，重置内容

## 水印

假如我们想要生成以下的水印

- 水印内容为文本
- 行间有错行效果

<ImgZoom src="/best_practice/watermark.jpeg" />

### canvas 生成水印

canvas 方案大致为以下步骤：

1. 创建一个`canvas`画布
2. 使用 `fillText` 将文本添加到画布中
3. 通过`canvas.toDataUrl`输出为图片
4. 将图片设置为全屏 div 的背景

```html
<body style="height: 1000px;">
  <script>
    (function () {
      // canvas 实现 watermark
      function __canvasWM({
        // 使用 ES6 的函数默认值方式设置参数的默认取值
        // 具体参见 https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Default_parameters
        container = document.body,
        width = '200px',
        height = '200px',
        textAlign = 'center',
        textBaseline = 'middle',
        font = '12px',
        fillStyle = 'rgba(184, 184, 184, 0.6)',
        content = '请勿外传',
        rotate = '-20',
        zIndex = 1000,
      } = {}) {
        var args = arguments[0];
        var canvas = document.createElement('canvas');

        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);
        var ctx = canvas.getContext('2d');

        ctx.textAlign = textAlign;
        ctx.textBaseline = textBaseline;
        ctx.font = font;
        ctx.fillStyle = fillStyle;
        ctx.rotate((Math.PI / 180) * rotate);
        ctx.fillText(content, parseFloat(width) * 0.2, parseFloat(height) * 0.2);
        ctx.fillText(content, parseFloat(width) * 0.5, parseFloat(height) * 0.8);

        var base64Url = canvas.toDataURL();
        const watermarkDiv = document.createElement('div');
        watermarkDiv.setAttribute(
          'style',
          `
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            z-index:${zIndex};
            pointer-events:none;
            background-repeat:repeat;
            background-image:url('${base64Url}')`
        );

        container.style.position = 'relative';
        container.insertBefore(watermarkDiv, container.firstChild);
      }

      window.__canvasWM = __canvasWM;
    })();

    // 调用
    __canvasWM({
      content: 'wuzhuang.jack',
    });
  </script>
</body>
```

### svg 生成水印

当我们的水印只需要文本时，用 SVG 实现水印较为简单

1. 创建 `svg` 标签
2. 在 svg 内添加 `text` 标签，将文本设置为 text 标签的 innerHtml
3. 通过 `Base64.tobase64(new XMLSerializer().serializeToString(svgElement))` 将 svg 标签输出为 base64 格式图片
4. 将图片设置为水印 div 背景

### Element 水印

使用元素生成水印就是将一个个标签添加到 div 中，实现起来简单，但是会在页面内添加较多的标签

### Node 生成水印

服务端生成水印可行，但是不建议，会消耗无谓的资源

1. 安装 [gm](https://github.com/aheckmann/gm)

```js
const fs = require('fs');
const gm = require('gm');
const imageMagick = gm.subClass({
  imageMagick: true,
});

const router = require('koa-router')();

router.get('/wm', async (ctx, next) => {
  const { text } = ctx.query;

  ctx.type = 'image/png';
  ctx.status = 200;
  ctx.body = await (() => {
    return new Promise((resolve, reject) => {
      imageMagick(200, 100, 'rgba(255,255,255,0)')
        .fontSize(40)
        .drawText(10, 50, text)
        .write(require('path').join(__dirname, `./${text}.png`), function (err) {
          if (err) {
            reject(err);
          } else {
            resolve(fs.readFileSync(require('path').join(__dirname, `./${text}.png`)));
          }
        });
    });
  })();
});
```

## 保护水印

保护水印主要从以下几个角度考虑

1. 删除全屏水印 div
2. 修改水印样式，使之不可见
3. 修改或删除水印图片的内容
4. 禁用 JavaScript：禁用之后，执行水印的代码就无法执行了

保护水印主要依靠的是 `MutationObserver`

```js
const targetNode = document.getElementById('watermark');
const callback = function (mutations, observer) {
  /* do something */
};
const config = { attributes: true, childList: true, subtree: true };
observer.observe(targetNode, config);
observer.disconnect();
```

### 防止删除水印 div

被监听的节点自身被删除的话，是不会触发 `MutationObserver`回调的，我们可以监听其父元素

我们可以存储可能被删除的水印 div，被删除之后，重新添加到父元素下面

```js
parentNode.appendChild(elementRef.current);
```

### 防止修改水印的样式

只有行内样式的修改才会触发回调，class 存储中的样式修改不会触发

### 防止修改内容

<br />
<br />
<br />

- **参考博文**
  - [前端水印生成方案(网页水印+图片水印)](https://juejin.cn/post/6844903645155164174#heading-9)
  - [使用 MutationObserver 简单实现文本水印](https://tech.bytedance.net/articles/6992889569498628126#comment-panel)
