# 包管理器

## 1. NPM

npm/yarn install 之后，首先会构建依赖数，然后针对每个节点下的包，会经历下面四个步骤

1. 将依赖的包的版本区间解析为某个具体的版本号
2. 下载对应版本依赖的 tar 包到本地离线镜像
3. 将依赖从离线镜像解压到本地缓存
4. 将依赖存缓存拷贝到单签目录的 node_modules

从 npm3 开始，都是采用扁平化的 node_modules 来管理，所有的依赖都会出现在顶层 node_modules 中

### 1.1 扁平化的问题

1. 依赖结构的不确定性
2. 扁平化算法的复杂性很高，耗时较长
3. 项目中可以非法访问没有声明过依赖的包

#### 为什么依赖结构不确定？

如果 foo、bar 依赖了两个不同版本的 `fn@1.0.1`、`fn@1.0.4`，那么顶层 node_modules 中出现的将会是哪个版本？都有可能，取决于 foo、bar 出现在 package.json 中的位置，谁在前面，对应的 fn 就会在顶层。
这也是 package-lock.json 出现的原因，保证 install 之后产生确定的 node_modules 结构

## 2. Yarn

yarn 的出现是为了解决 npm 安装慢、安装的不一致问题

### 2.1 特性

#### 1. 速度快

1. 在 npm 基础上做的优化，相同的包不会再请求网络，直接请求本地缓存
2. yarn 的安装任务是同步执行的

##### 2. 版本统一

使用 yarn.lock 统一包版本

#### 3. 更简洁的输出

#### 4. 多注册来源处理

所有的依赖包，不管他被不同的库间接关联引用多少次，安装这个包时，只会从一个注册来源去装，要么是 npm 要么是 bower, 防止出现混乱不一致。

## 3. Pnpm

### 3.1 特性

#### 1. 速度快

在绝大多数场景下，包安装速度都是明显优于 npm/yarn 的，速度会快 2~3 倍。

#### 2. 高效利用磁盘空间

不会重复安装同一个包

1. 如果 100 个项目都依赖 lodash，pnpm 在磁盘中只会写入一次，其他地方都会使用硬链接
2. 一个包的不同版本，如果有一个文件不一样，仅会写入改变的这个文件，其他的使用硬链接

使用 npm 安装依赖时，所有的依赖都会被提升到模块的根目录，因此项目可以访问到未被添加进当前项目的依赖。

pnpm 使用软链的方式将项目的依赖添加进模块文件的根目录。

- [扁平的 node_modules 不是唯一的方法](https://pnpm.io/blog/2020/05/27/flat-node-modules-is-not-the-only-way)：详解 pnpm 包的目录结构
- [基于符号链接的 node_modules 结构](https://pnpm.io/symlinked-node-modules-structure)

#### 3. 支持 monorepo

pnpm 与 npm/yarn 另外一个很大的不同就是支持 monorepo，体现在哥哥子命令的功能上，比如在根目录下 `pnpm add A -r` ，那么所有 package 中都会添加这个依赖

#### 4. 安全性高

使用 npm/yarn 时，由于 node_modules 的扁平结构，如果 A 依赖 B，B 依赖 C，那么 A 中是可以直接使用 C 的，但是 A 中并没有声明这个 C。
但是 pnpm 自创了一套依赖管理方式，很好的解决了这个问题，保证了安全性

### 3.2 使用

#### pnpm install

```bash
pnpm install axios -D
pnpm install axios --filter package_name   # 下同
```

#### pnpm update

#### pnpm uninstall

#### pnpm link

### 3.3 依赖管理

顶层的 node_modules 是扁平的 软链文件，软链的源文件依然是嵌套结构

```
▾ node_modules
  ▾ .pnpm
    ▸ accepts@1.3.7
    ▸ array-flatten@1.1.1
    ...
    ▾ express@4.17.1
      ▾ node_modules
        ▸ accepts
        ▸ array-flatten
        ▸ body-parser
        ▸ content-disposition
        ...
        ▸ etag
        ▾ express
          ▸ lib
            History.md
            index.js
            LICENSE
            package.json
            Readme.md

```

- **博文参考**
  - [关于现代包管理器的深度思考——为什么现在我更推荐 pnpm 而不是 pm/yarn?](https://juejin.cn/post/6932046455733485575)
